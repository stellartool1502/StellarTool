<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon-16x16.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>eSign PDF Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        canvas {
            border: 1px solid #ccc;
            margin-top: 20px;
            background-color: white;
            cursor: crosshair;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #signaturePadContainer {
            margin-top: 20px;
        }

        input[type="number"], select {
            padding: 8px;
            margin: 10px 5px;
            width: 120px;
        }

        #customPos {
            display: none;
        }

        #status {
            margin-top: 10px;
            color: #333;
            min-height: 20px;
        }

        .status-ready {
            color: green;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .container {
                width: 90%;
            }
            input[type="number"], select {
                width: 100px;
            }
        }
    </style>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>eSign PDF Tool</h1>
        
        <input type="file" id="pdfInput" accept="application/pdf" />
        <div id="signaturePadContainer">
            <p><strong>Draw your signature below:</strong></p>
            <canvas id="signaturePadCanvas" width="400" height="200"></canvas>
        </div>
        <div>
            <label><strong>Signature Position:</strong></label><br>
            <select id="posPreset">
                <option value="husband">Bottom-Left (Husband)</option>
                <option value="wife">Bottom-Right (Wife)</option>
                <option value="custom">Custom</option>
            </select>
            <div id="customPos">
                <input type="number" id="posX" placeholder="X (e.g., 50)" min="0">
                <input type="number" id="posY" placeholder="Y (e.g., 100)" min="0">
            </div>
            <p id="pageInfo" style="font-size: 14px; color: #666;"></p>
        </div>
        <button id="clearBtn">Clear Signature</button>
        <button id="downloadBtn" disabled>Download Signed PDF</button>
        <div id="status">Upload a PDF and draw your signature to enable download</div>
    </div>

    <script>
        // DOM Elements
        const pdfInput = document.getElementById("pdfInput");
        const signaturePadCanvas = document.getElementById("signaturePadCanvas");
        const clearBtn = document.getElementById("clearBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const posPreset = document.getElementById("posPreset");
        const customPos = document.getElementById("customPos");
        const posX = document.getElementById("posX");
        const posY = document.getElementById("posY");
        const statusEl = document.getElementById("status");
        const pageInfo = document.getElementById("pageInfo");

        // State variables
        let signaturePad = null;
        let pdfDocBytes = null;
        let hasSignature = false;
        let hasPDF = false;

        // Initialize Signature Pad
        function initializeSignaturePad() {
            signaturePad = new SignaturePad(signaturePadCanvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                throttle: 5
            });

            // Add event listeners for drawing
            signaturePad.addEventListener("beginStroke", () => {
                console.log("Started drawing signature");
            });

            signaturePad.addEventListener("endStroke", () => {
                hasSignature = !signaturePad.isEmpty();
                console.log("Finished drawing signature, isEmpty:", signaturePad.isEmpty());
                updateDownloadButton();
            });

            // Also listen to mouse and touch events directly as backup
            signaturePadCanvas.addEventListener('mouseup', checkSignature);
            signaturePadCanvas.addEventListener('touchend', checkSignature);
        }

        function checkSignature() {
            setTimeout(() => {
                hasSignature = !signaturePad.isEmpty();
                console.log("Manual check - hasSignature:", hasSignature);
                updateDownloadButton();
            }, 100);
        }

        // Update download button state
        function updateDownloadButton() {
            console.log("Updating button - hasPDF:", hasPDF, "hasSignature:", hasSignature);
            
            const shouldEnable = hasPDF && hasSignature;
            downloadBtn.disabled = !shouldEnable;

            if (shouldEnable) {
                statusEl.textContent = "✓ Ready to download signed PDF!";
                statusEl.className = "status-ready";
            } else {
                statusEl.className = "";
                if (!hasPDF) {
                    statusEl.textContent = "Please upload a PDF file first";
                } else if (!hasSignature) {
                    statusEl.textContent = "Please draw your signature above";
                } else {
                    statusEl.textContent = "Upload a PDF and draw your signature to enable download";
                }
            }
        }

        // Show/hide custom position inputs
        posPreset.addEventListener("change", () => {
            customPos.style.display = posPreset.value === "custom" ? "block" : "none";
        });

        // Handle PDF file upload
        pdfInput.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== "application/pdf") {
                statusEl.textContent = "❌ Please select a PDF file";
                hasPDF = false;
                updateDownloadButton();
                return;
            }

            statusEl.textContent = "Loading PDF...";
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    pdfDocBytes = e.target.result;
                    hasPDF = true;
                    
                    // Try to get page dimensions for info
                    PDFLib.PDFDocument.load(pdfDocBytes).then(pdfDoc => {
                        const firstPage = pdfDoc.getPages()[0];
                        const { width, height } = firstPage.getSize();
                        pageInfo.textContent = `Page size: ${width.toFixed(0)} x ${height.toFixed(0)} points`;
                        statusEl.textContent = "✓ PDF loaded successfully! Now draw your signature.";
                        updateDownloadButton();
                    }).catch(err => {
                        console.warn("Could not analyze PDF, but continuing anyway:", err);
                        statusEl.textContent = "✓ PDF loaded! Now draw your signature.";
                        updateDownloadButton();
                    });
                    
                } catch (error) {
                    statusEl.textContent = "❌ Error loading PDF: " + error.message;
                    hasPDF = false;
                    updateDownloadButton();
                }
            };

            reader.onerror = function() {
                statusEl.textContent = "❌ Error reading file";
                hasPDF = false;
                updateDownloadButton();
            };

            reader.readAsArrayBuffer(file);
        });

        // Clear signature
        clearBtn.addEventListener("click", () => {
            if (signaturePad) {
                signaturePad.clear();
                hasSignature = false;
                statusEl.textContent = "Signature cleared. Draw a new signature.";
                updateDownloadButton();
            }
        });

        // Download signed PDF
        downloadBtn.addEventListener("click", async () => {
            if (!hasPDF || !hasSignature) {
                alert("Please upload a PDF and draw a signature first.");
                return;
            }

            statusEl.textContent = "Creating signed PDF...";
            downloadBtn.disabled = true;

            try {
                // Load the PDF document
                const pdfDoc = await PDFLib.PDFDocument.load(pdfDocBytes);
                
                // Convert signature to PNG
                const signatureDataURL = signaturePad.toDataURL();
                const pngImage = await pdfDoc.embedPng(signatureDataURL);

                // Get first page
                const pages = pdfDoc.getPages();
                const firstPage = pages[0];
                const { width, height } = firstPage.getSize();

                // Calculate signature position
                let x, y;
                const sigWidth = 120;
                const sigHeight = 60;

                switch (posPreset.value) {
                    case 'husband':
                        x = 50;
                        y = 50;
                        break;
                    case 'wife':
                        x = width - sigWidth - 50;
                        y = 50;
                        break;
                    case 'custom':
                        x = parseFloat(posX.value) || 50;
                        y = parseFloat(posY.value) || 50;
                        break;
                    default:
                        x = 50;
                        y = 50;
                }

                // Draw signature on PDF
                firstPage.drawImage(pngImage, {
                    x: x,
                    y: y,
                    width: sigWidth,
                    height: sigHeight,
                    opacity: 1
                });

                // Save and download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'signed-document.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                statusEl.textContent = "✓ Signed PDF downloaded successfully!";
                downloadBtn.disabled = false;

            } catch (error) {
                console.error("Error creating signed PDF:", error);
                statusEl.textContent = "❌ Error creating signed PDF: " + error.message;
                downloadBtn.disabled = false;
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignaturePad();
            updateDownloadButton();
            console.log("eSign Tool initialized");
        });
    </script>
</body>
</html>
