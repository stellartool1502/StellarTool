<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="favicon-16x16.png" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StellarTool — Background Remover & Compressor</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0.5/dist/body-pix.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9512844386742996" crossorigin="anonymous"></script>
  <style>
    :root{
      --blue: #00c4ff;
      --blue-700: #0077cc;
      --bg: #1a1f2e;
      --accent: #0b84d8;
      --muted: #a0a8b8;
      --radius: 14px;
      --glass: rgba(28, 33, 50, 0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#e0e6f0}

    .app{
      max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start;
    }

    header{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{margin:6px 0 16px;color:var(--muted)}

    .panel{background:linear-gradient(180deg, rgba(44, 47, 62, 0.9), rgba(44, 47, 62, 0.85));padding:18px;border-radius:16px;box-shadow:0 6px 20px rgba(11,84,128,0.3)}
    .upload-area{border:2px dashed rgba(10,165,255,0.22);padding:18px;border-radius:12px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;min-height:170px}
    .upload-area.dragover{background:rgba(10,165,255,0.03);border-color:var(--blue-700)}
    
    input[type=file] {
      display: none;
    }
    
    .btn {
      background: linear-gradient(90deg, #00c4ff, #8e2de2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    
    .btn:hover {
      opacity: 0.8;
    }
    
    .btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }
    
    .result-area {
      min-height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px dashed #40445a;
      border-radius: 12px;
      padding: 20px;
      background: rgba(44, 47, 62, 0.5);
    }
    
    .result-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      display: none;
    }
    
    .loading {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #333854;
      border-top: 4px solid var(--blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .download-btn {
      margin-top: 15px;
      display: none;
    }
    
    .file-info {
      margin: 10px 0;
      padding: 10px;
      background: #333854;
      border-radius: 8px;
      display: none;
      color: #e0e6f0;
    }
    
    .error {
      color: #ff6b6b;
      background: #2c2f3e;
      padding: 10px;
      border-radius: 8px;
      display: none;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <header>
        <div class="logo">ST</div>
        <h1>StellarTool — Background Remover</h1>
      </header>
      <p class="lead">Upload an image to remove its background automatically</p>
      
      <div class="upload-area" id="uploadArea">
        <p>Drag & drop your image here</p>
        <p>or</p>
        <button class="btn" id="uploadBtn">Choose File</button>
        <input type="file" id="fileInput" accept="image/*">
      </div>
      
      <div class="file-info" id="fileInfo">
        <strong>Selected:</strong> <span id="fileName"></span>
        <br>
        <strong>Size:</strong> <span id="fileSize"></span>
      </div>
      
      <div class="error" id="errorMessage"></div>
      
      <button class="btn" id="processBtn" disabled>Remove Background</button>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Removing background... Please wait</p>
      </div>
    </div>
    
    <div class="panel">
      <h2>Result</h2>
      <div class="result-area" id="resultArea">
        <p>Your processed image will appear here</p>
        <img id="resultImage" class="result-image" alt="Processed result">
        <a id="downloadBtn" class="btn download-btn" download="background-removed.png">Download Image</a>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const processBtn = document.getElementById('processBtn');
    const resultArea = document.getElementById('resultArea');
    const resultImage = document.getElementById('resultImage');
    const downloadBtn = document.getElementById('downloadBtn');
    const loading = document.getElementById('loading');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const errorMessage = document.getElementById('errorMessage');

    let selectedFile = null;
    let net = null;

    // Initialize BodyPix model
    async function initializeModel() {
      try {
        loading.style.display = 'flex';
        loading.querySelector('p').textContent = 'Loading AI model...';
        
        net = await bodyPix.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          multiplier: 0.75,
          quantBytes: 2
        });
        
        console.log('BodyPix model loaded successfully');
      } catch (error) {
        console.error('Error loading model:', error);
        showError('Failed to load AI model. Please refresh the page.');
      } finally {
        loading.style.display = 'none';
      }
    }

    // File handling
    uploadBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    function handleFileSelect(file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showError('Please select an image file (JPEG, PNG, etc.)');
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showError('File size too large. Please select an image under 10MB.');
        return;
      }

      selectedFile = file;
      
      // Update file info
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.style.display = 'block';
      
      // Enable process button
      processBtn.disabled = false;
      
      // Clear previous errors
      hideError();
      
      console.log('File selected:', file.name);
    }

    // Process image
    processBtn.addEventListener('click', async () => {
      if (!selectedFile) {
        showError('Please select an image first.');
        return;
      }

      if (!net) {
        showError('AI model is still loading. Please wait...');
        return;
      }

      try {
        loading.style.display = 'flex';
        loading.querySelector('p').textContent = 'Removing background... Please wait';
        processBtn.disabled = true;

        // Create image element
        const img = new Image();
        img.src = URL.createObjectURL(selectedFile);
        
        await new Promise((resolve) => {
          img.onload = resolve;
        });

        // Perform segmentation
        const segmentation = await net.segmentPerson(img, {
          flipHorizontal: false,
          internalResolution: 'medium',
          segmentationThreshold: 0.7
        });

        // Create canvas for background removal
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');

        // Draw original image
        ctx.drawImage(img, 0, 0);

        // Get image data
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        // Remove background (set alpha to 0 for background pixels)
        for (let i = 0; i < segmentation.data.length; i++) {
          if (segmentation.data[i] === 0) { // Background
            data[i * 4 + 3] = 0; // Set alpha to 0
          }
        }

        // Put modified image data back
        ctx.putImageData(imageData, 0, 0);

        // Convert to blob and display
        canvas.toBlob((blob) => {
          const resultUrl = URL.createObjectURL(blob);
          
          // Display result
          resultImage.src = resultUrl;
          resultImage.style.display = 'block';
          resultArea.querySelector('p').style.display = 'none';
          
          // Setup download
          downloadBtn.href = resultUrl;
          downloadBtn.style.display = 'block';
          
          loading.style.display = 'none';
          processBtn.disabled = false;
          
          console.log('Background removal completed');
        }, 'image/png');

      } catch (error) {
        console.error('Error processing image:', error);
        showError('Error processing image: ' + error.message);
        loading.style.display = 'none';
        processBtn.disabled = false;
      }
    });

    // Utility functions
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    // Initialize the app
    initializeModel();
  </script>
  <script type="text/javascript">
    atOptions = {
      'key' : 'f7b18c73a8f42791ff9348b5265ad846',
      'format' : 'iframe',
      'height' : 50,
      'width' : 320,
      'params' : {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/f7b18c73a8f42791ff9348b5265ad846/invoke.js"></script>
</body>
</html>
